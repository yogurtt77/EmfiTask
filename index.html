<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>amoCRM Deals</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .status-circle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }
      .status-circle[fill="blue"] {
        fill: #007bff;
      }
      .deal-row {
        cursor: pointer;
      }
      .deal-row:hover {
        background-color: #f8f9fa;
      }
      .expanded-row {
        background-color: #f1f8ff;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1 class="mb-4">Сделки amoCRM</h1>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>ID сделки</th>
              <th>Название сделки</th>
              <th>Бюджет</th>
              <th>ID контакта</th>
              <th>Имя контакта</th>
              <th>Телефон</th>
            </tr>
          </thead>
          <tbody id="dealsTable">
            <!-- Сюда будут добавляться сделки -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Конфигурация
      const config = {
        accessToken:
          "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjAwNmQ2YTYyMGYwYzVmMjIwNTVlY2ViNGUyYzI3ZWE2NmU3N2ZmOTk0MTM1NTE2ZWQwZmFkMjE2ODdkMDExYTIzNmU1Yjg2YzIwYTBhMDEwIn0.eyJhdWQiOiJmNzVmMWIwYS0zMjU2LTQyYzEtYWUzYi0zMGRiNDA0N2EyMjEiLCJqdGkiOiIwMDZkNmE2MjBmMGM1ZjIyMDU1ZWNlYjRlMmMyN2VhNjZlNzdmZjk5NDEzNTUxNmVkMGZhZDIxNjg3ZDAxMWEyMzZlNWI4NmMyMGEwYTAxMCIsImlhdCI6MTc0MzcwNTExMiwibmJmIjoxNzQzNzA1MTEyLCJleHAiOjE3NDM3OTE1MTIsInN1YiI6IjEyMzI0MjgyIiwiZ3JhbnRfdHlwZSI6IiIsImFjY291bnRfaWQiOjMyMzI5OTc4LCJiYXNlX2RvbWFpbiI6ImFtb2NybS5ydSIsInZlcnNpb24iOjIsInNjb3BlcyI6WyJwdXNoX25vdGlmaWNhdGlvbnMiLCJmaWxlcyIsImNybSIsImZpbGVzX2RlbGV0ZSIsIm5vdGlmaWNhdGlvbnMiXSwiaGFzaF91dWlkIjoiNmI3M2Y4NTUtNTNlMS00NGYxLWEyNDQtZmI0MzgxMjZiYTc0IiwiYXBpX2RvbWFpbiI6ImFwaS1iLmFtb2NybS5ydSJ9.TVmTfKzjajLMHhvGZKqeDFeRcdWgf-4puCfcewykEAA4Fd9MsdelkdMBQMeaA4j0AIK4483XYuGw-uzpf_69JTdAeUY20_-4lFn4MAuUnYYWupCdlofWXuiCnUrn6uGcfDNPm32Uf8DUGNKtpchcu8gwNVfCHDdUKMLcQmEOVlEz0iS7rjzF1FHmEOUKWX8aHBoaYDfLx78sLilNfSFY0vXH90OjtG5rdC8sZ2vccl978cVim3lyRZyglwPjIoVA6mMYx3y9WT9ilFuqDhBXP0LtjWpSzj1ol555cRI6lICRBO7cTGAadHLupyF2uU6UmbpqybT7sjwiaL_f4RR0JA",
        refreshToken:
          "def5020074b9d798e1a3da4e183e8bb8400c76f0b3740147d0355345a88bcdd78b6d54e7816b8a0c7f3d8b946b1a70449efe3a634db4ddfe03274bfff48a5dc552e1b514fd283c5f5dfde227c5eb8376872b34413f576a6758f68c429b40958df01950f6013ee715fc9ec6c6e2671e65992407903c76a952b39e89e2383481e5b6491d8d1f90dad767ae30a6713c9c63cbd15796ad62cfbd3a0bd8474d6e337d3bf9265a30d1ff2497d13fb41b29d06a35517ffee61ec96341954e2a0499e5be498b4bdd2881035e4590621b0d5d9e026bd0424459d62c52ab4d92f013843dd1f219b00d04e298cb83c72a0b45bb507a53b9e6494d29b33e521ac7141811d80dae2ef6f1bcc5951c467266f0e373f3ce0dd9e255a7eb92f99bb035933a864e80e943ace84341c221a2922af9bcdf8c2c42880eb142e3210dae1b821d87f3c803e5d84e7e36bd37288276a35be04290cc439f998cf36afd7d26348be593d88e535684716d2d05b8b951f85a5a37874457f704fd049e9906d672db2b3f80b193054e0a6495ad64f7678241b90734c0cded0fb9a4c4de8cb71a1bd29e090608a2e10258452c7cdacdd36a0927303e1dcd95475dfd80d7664a1a2e5d6053f83ec41cbc2c9868b33116e51fe76272cae7dd97ed8c42154beb6b2face3753ebb6f94b2bf43a1bbde8d",
        clientId: "f75f1b0a-3256-42c1-ae3b-30db4047a221", // из вашего токена
        accountDomain: "absatnurlybek.amocrm.ru",
        requestsPerSecond: 2,
        batchSize: 2,
        tokenEndpoint: "https://absatnurlybek.amocrm.ru/oauth2/access_token",
      };

      // Глобальные переменные
      let deals = [];
      let contacts = [];
      let expandedDealId = null;
      let lastRequestTime = 0;
      let requestQueue = [];

      // Инициализация при загрузке страницы
      document.addEventListener("DOMContentLoaded", async function () {
        await loadDealsAndContacts();
        renderDealsTable();
      });

      // Функция обновления токена
      async function refreshAccessToken() {
        try {
          const response = await fetch(config.tokenEndpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              client_id: config.clientId,
              grant_type: "refresh_token",
              refresh_token: config.refreshToken,
            }),
          });

          if (!response.ok) {
            throw new Error(`Ошибка обновления токена: ${response.status}`);
          }

          const data = await response.json();
          config.accessToken = data.access_token;
          config.refreshToken = data.refresh_token;

          console.log("Токен успешно обновлен");
          return true;
        } catch (error) {
          console.error("Ошибка при обновлении токена:", error);
          return false;
        }
      }

      async function fetchWithRateLimit(url, options = {}) {
        return new Promise(async (resolve, reject) => {
          const attemptRequest = async (retryCount = 0) => {
            if (retryCount > 1) {
              reject(new Error("Превышено количество попыток запроса"));
              return;
            }

            try {
              const now = Date.now();
              const timeSinceLastRequest = now - lastRequestTime;
              const minDelay = 1000 / config.requestsPerSecond;

              if (timeSinceLastRequest < minDelay) {
                await new Promise((resolve) =>
                  setTimeout(resolve, minDelay - timeSinceLastRequest)
                );
              }

              lastRequestTime = Date.now();

              const fetchOptions = {
                ...options,
                headers: {
                  ...(options.headers || {}),
                  Authorization: `Bearer ${config.accessToken}`,
                  "Content-Type": "application/json",
                },
              };

              const response = await fetch(url, fetchOptions);

              if (response.status === 401) {
                console.log("Токен устарел, пытаемся обновить...");
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                  return attemptRequest(retryCount + 1);
                } else {
                  throw new Error("Не удалось обновить токен");
                }
              }

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              resolve(data);
            } catch (error) {
              if (error.message.includes("401") && retryCount === 0) {
                return attemptRequest(retryCount + 1);
              }
              reject(error);
            }
          };

          requestQueue.push({
            attemptRequest,
            resolve,
            reject,
          });

          processQueue();
        });
      }

      async function processQueue() {
        if (requestQueue.length === 0) return;

        const { attemptRequest, resolve, reject } = requestQueue.shift();

        try {
          await attemptRequest();
        } catch (error) {
          reject(error);
        }

        processQueue();
      }

      async function loadDealsAndContacts() {
        try {
          const dealsResponse = await fetchWithRateLimit(
            `${getApiUrl()}/api/v4/leads?with=contacts`
          );
          deals = dealsResponse._embedded.leads || [];

          const contactIds = [];
          deals.forEach((deal) => {
            if (deal._embedded?.contacts) {
              deal._embedded.contacts.forEach((contact) => {
                if (!contactIds.includes(contact.id)) {
                  contactIds.push(contact.id);
                }
              });
            }
          });

          if (contactIds.length > 0) {
            contacts = await loadContactsBatch(contactIds);
          } else {
            contacts = [];
          }
        } catch (error) {
          console.error("Ошибка загрузки данных:", error);
          alert(
            "Ошибка при загрузке данных. Проверьте консоль для подробностей."
          );
        }
      }

      // Остальные функции остаются без изменений
      async function loadContactsBatch(contactIds) {
        const batchSize = 2;
        const allContacts = [];

        for (let i = 0; i < contactIds.length; i += batchSize) {
          const batch = contactIds.slice(i, i + batchSize);
          try {
            const response = await fetchWithRateLimit(
              `${getApiUrl()}/api/v4/contacts?filter[id]=${batch.join(
                ","
              )}&with=custom_fields`
            );
            const loadedContacts = response._embedded?.contacts || [];
            allContacts.push(...loadedContacts);

            if (i + batchSize < contactIds.length) {
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }
          } catch (error) {
            console.error(`Ошибка загрузки контактов ${batch}:`, error);
            for (const id of batch) {
              try {
                const singleResponse = await fetchWithRateLimit(
                  `${getApiUrl()}/api/v4/contacts/${id}?with=custom_fields`
                );
                allContacts.push(singleResponse);
              } catch (e) {
                console.error(`Не удалось загрузить контакт ${id}:`, e);
              }
            }
          }
        }

        return allContacts;
      }

      function renderDealsTable() {
        const tableBody = document.getElementById("dealsTable");
        tableBody.innerHTML = "";

        deals.forEach((deal) => {
          const row = document.createElement("tr");
          row.className = "deal-row";
          row.dataset.dealId = deal.id;

          const dealContacts = getContactsForDeal(deal);
          const allPhones = dealContacts
            .map((contact) => getContactPhone(contact))
            .filter((phone) => phone !== "Нет телефона");

          const contactsDisplay =
            dealContacts.length > 0
              ? dealContacts.map((c) => c.id).join(", ")
              : "Нет";

          const phonesDisplay =
            allPhones.length > 0 ? allPhones.join(", ") : "Нет телефона";

          row.innerHTML = `
            <td>${deal.id}</td>
            <td>${deal.name || "Без названия"}</td>
            <td>${deal.price || 0}₸</td>
            <td>${contactsDisplay}</td>
            <td>${
              dealContacts.map((c) => c.name || "Без имени").join(", ") || "Нет"
            }</td>
            <td>${phonesDisplay}</td>
          `;

          row.onclick = () => toggleDealDetails(deal.id);
          tableBody.appendChild(row);
        });
      }

      async function toggleDealDetails(dealId) {
        const tableBody = document.getElementById("dealsTable");
        const selectedRow = tableBody.querySelector(
          `tr[data-deal-id="${dealId}"]`
        );

        // Проверяем, есть ли уже открытая карточка для этой сделки
        const existingDetailsRow = selectedRow.nextElementSibling;

        // Если карточка уже открыта - закрываем её
        if (
          existingDetailsRow &&
          existingDetailsRow.classList.contains("expanded-details")
        ) {
          selectedRow.classList.remove("expanded-row");
          existingDetailsRow.remove();
          expandedDealId = null;
          return;
        }

        // Закрываем предыдущую открытую карточку, если есть
        if (expandedDealId && expandedDealId !== dealId) {
          const prevRow = tableBody.querySelector(
            `tr[data-deal-id="${expandedDealId}"]`
          );
          if (prevRow) {
            const prevDetailsRow = prevRow.nextElementSibling;
            if (
              prevDetailsRow &&
              prevDetailsRow.classList.contains("expanded-details")
            ) {
              prevRow.classList.remove("expanded-row");
              prevDetailsRow.remove();
            }
          }
        }

        // Открываем новую карточку
        selectedRow.classList.add("expanded-row");
        expandedDealId = dealId;

        // Создаем строку для деталей с индикатором загрузки
        const detailsRow = document.createElement("tr");
        detailsRow.className = "expanded-details";
        detailsRow.innerHTML = `
    <td colspan="6">
      <div class="d-flex justify-content-center">
        <div class="loading-spinner"></div>
        <span class="ms-2">Загрузка деталей...</span>
      </div>
    </td>
  `;

        selectedRow.insertAdjacentElement("afterend", detailsRow);

        try {
          const dealDetailsResponse = await fetchWithRateLimit(
            `${getApiUrl()}/api/v4/leads/${dealId}?with=tasks`
          );
          const dealDetails = dealDetailsResponse;
          const tasks = dealDetails._embedded?.tasks || [];
          const closestTask = tasks[0];

          let taskDate = "";
          let taskStatus = "";
          let statusColor = "gray"; // По умолчанию серый (нет задачи)

          if (closestTask) {
            const taskDateObj = new Date(closestTask.complete_till * 1000);
            taskDate = formatDateTime(taskDateObj);
            taskStatus = closestTask.name || "Задача без названия";

            const now = new Date();
            const taskTime = taskDateObj.getTime();
            const currentTime = now.getTime();

            // Разница в миллисекундах
            const diffMs = taskTime - currentTime;
            // Разница в днях (с округлением вниз)
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            // Определяем статус
            if (diffMs < 0) {
              // Просрочено (красный)
              statusColor = "red";
            } else if (diffDays === 0) {
              // Сегодня (зеленый)
              statusColor = "green";
            } else if (diffDays === 1) {
              // Завтра (желтый)
              statusColor = "yellow";
            } else {
              // Будущее (синий)
              statusColor = "blue";
            }
          }

          detailsRow.innerHTML = `
      <td colspan="6">
        <div class="p-3">
          <h5>Детали сделки</h5>
          <div class="row">
            <div class="col-md-6">
              <p><strong>ID:</strong> ${dealDetails.id}</p>
              <p><strong>Название:</strong> ${
                dealDetails.name || "Без названия"
              }</p>
              <p><strong>Бюджет:</strong> ${dealDetails.price || 0} ₸</p>
            </div>
            <div class="col-md-6">
              <p><strong>Ближайшая задача:</strong> ${
                taskStatus || "Нет задач"
              }</p>
              <p><strong>Дата задачи:</strong> ${taskDate || "Нет"}</p>
              <p><strong>Статус:</strong> 
                <svg class="status-circle" viewBox="0 0 16 16">
                  <circle cx="8" cy="8" r="8" fill="${statusColor}"/>
                </svg>
                ${getStatusText(statusColor)}
              </p>
            </div>
          </div>
        </div>
      </td>
    `;
        } catch (error) {
          console.error("Error loading deal details:", error);
          detailsRow.innerHTML = `
      <td colspan="6" class="text-danger">
        Ошибка при загрузке деталей сделки. Проверьте консоль для подробностей.
      </td>
    `;
        }
      }

      // Новая функция для форматирования даты и времени
      function formatDateTime(date) {
        if (!date) return "";
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");
        return `${day}.${month}.${year} ${hours}:${minutes}`;
      }

      // Вспомогательные функции
      function getApiUrl() {
        return `https://${config.accountDomain}`;
      }

      function getContactsForDeal(deal) {
        if (!deal._embedded?.contacts) return [];
        return deal._embedded.contacts
          .map((contact) => contacts.find((c) => c.id === contact.id))
          .filter(Boolean);
      }

      function getContactPhone(contact) {
        if (!contact) return "Нет контакта";

        const phoneFields =
          contact.custom_fields_values?.filter(
            (f) =>
              f.field_code === "PHONE" ||
              /телефон|phone|teneфон/i.test(f.field_name || "") ||
              f.field_type === "multitext"
          ) || [];

        for (const field of phoneFields) {
          if (field.values?.length > 0 && field.values[0].value) {
            return formatPhone(field.values[0].value);
          }
        }

        return "Нет телефона";
      }

      function formatPhone(phone) {
        return phone.replace(/[^0-9+]/g, "");
      }

      function formatDate(date) {
        if (!date) return "";
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
      }

      function getStatusText(color) {
        switch (color) {
          case "red":
            return "Просрочено";
          case "green":
            return "Сегодня";
          case "yellow":
            return "Завтра";
          case "blue":
            return "Будущее";
          case "gray":
            return "Нет задачи";
          default:
            return "";
        }
      }
    </script>
  </body>
</html>
